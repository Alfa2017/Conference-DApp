var accounts, account;
var accountpwd = "1";
var clientpwd = "12346Uirfk*90frHKlDeweTr";
var optimize = 1;
var myConferenceInstance;


// Initialize
function initializeConference() {
	var cabi;
	var cexist = false;
	//address = address00;

	var address = "0xb44a787ddb8c0ec7fd06bd785531dac08b894d3b";
	//var cabi = [{"constant":true,"inputs":[{"name":"room_","type":"bytes32"}],"name":"GetMeeting","outputs":[{"name":"","type":"uint256"},{"name":"","type":"bytes32"},{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"room_","type":"bytes32"}],"name":"DeleteMeeting","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"room_","type":"bytes32"},{"name":"note_","type":"string"}],"name":"AddMeeting","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"room_","type":"bytes32"},{"name":"key_","type":"string"}],"name":"DeletePerson","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"GetMeetings","outputs":[{"name":"","type":"uint256"},{"name":"","type":"bytes32[]"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"room_","type":"bytes32"},{"name":"key_","type":"string"}],"name":"CheckPerson","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"room_","type":"bytes32"},{"name":"key_","type":"string"},{"name":"name_","type":"string"}],"name":"AddPerson","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"inputs":[],"payable":false,"stateMutability":"nonpayable","type":"constructor"}];

	//crypto
	//var ciphertext = CryptoJS.AES.encrypt('test message for client', clientpwd).toString();
	//var plaintext = CryptoJS.AES.decrypt(ciphertext, clientpwd).toString(CryptoJS.enc.Utf8);

	//get code of smart-contract Conference
	web3.eth.getCode(address, (error, result) => {
		if(error != null) {
			$("#confAddress").html("error!");
		}
		else {
			var sver = "soljson-v0.4.24+commit.e67f0147.js";
			var source = $('#smartContractCode').find('pre').text();

			//get avilable versions
			//BrowserSolc.getVersions(function(soljsonSources, soljsonReleases) {
			//});
			
			var bytecode = "0x";
			var conferenceContract;
			BrowserSolc.loadVersion(sver, function(c) {
				compiler = c;
				console.log("Solc Version Loaded: " + sver);

				var output = compiler.compile(source, optimize);
				var stringResult = JSON.stringify(output);

				bytecode = bytecode + output.contracts[':Conference'].bytecode;
				cabi = JSON.parse(output.contracts[':Conference'].interface);

				if( result == "0x" ) {
					conferenceContract = new web3.eth.Contract(cabi);
					conferenceContract.deploy({
						//data: "0x608060405234801561001057600080fd5b5033600260006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550611100806100616000396000f300608060405260043610610083576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff1680632cbf9110146100885780634ad475f01461014857806371307fd51461018d578063890461cc14610218578063ba4c4b1e1461028f578063df29c9cf14610302578063fd03e96914610391575b600080fd5b34801561009457600080fd5b506100b7600480360381019080803560001916906020019092919050505061044e565b60405180848152602001836000191660001916815260200180602001828103825283818151815260200191508051906020019080838360005b8381101561010b5780820151818401526020810190506100f0565b50505050905090810190601f1680156101385780820380516001836020036101000a031916815260200191505b5094505050505060405180910390f35b34801561015457600080fd5b506101776004803603810190808035600019169060200190929190505050610558565b6040518082815260200191505060405180910390f35b34801561019957600080fd5b506102026004803603810190808035600019169060200190929190803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290505050610762565b6040518082815260200191505060405180910390f35b34801561022457600080fd5b5061028d6004803603810190808035600019169060200190929190803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290505050610979565b005b34801561029b57600080fd5b506102a4610c14565b6040518083815260200180602001828103825283818151815260200191508051906020019060200280838360005b838110156102ed5780820151818401526020810190506102d2565b50505050905001935050505060405180910390f35b34801561030e57600080fd5b506103776004803603810190808035600019169060200190929190803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290505050610c7e565b604051808215151515815260200191505060405180910390f35b34801561039d57600080fd5b5061044c6004803603810190808035600019169060200190929190803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290505050610d51565b005b60008060606001600085600019166000191681526020019081526020016000206000015460016000866000191660001916815260200190815260200160002060010154600160008760001916600019168152602001908152602001600020600201808054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156105445780601f1061051957610100808354040283529160200191610544565b820191906000526020600020905b81548152906001019060200180831161052757829003601f168201915b505050505090509250925092509193909250565b6000806000600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16141515610622576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260168152602001807f53656e646572206e6f7420617574686f72697a65642e0000000000000000000081525060200191505060405180910390fd5b6000600160008660001916600019168152602001908152602001600020600001541115156106b8576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252600c8152602001807f556e6b6e6f776e20726f6f6d000000000000000000000000000000000000000081525060200191505060405180910390fd5b60016000856000191660001916815260200190815260200160002060000154915060006001600080549050038154811015156106f057fe5b906000526020600020015490508060008381548110151561070d57fe5b906000526020600020018160001916905550816001600086600019166000191681526020019081526020016000206000018190555060008054809190600190036107579190610f5e565b508192505050919050565b6000600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16141515610829576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260168152602001807f53656e646572206e6f7420617574686f72697a65642e0000000000000000000081525060200191505060405180910390fd5b6000600160008560001916600019168152602001908152602001600020600001541415156108bf576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260138152602001807f526f6f6d20616c7265616479206578697374730000000000000000000000000081525060200191505060405180910390fd5b60008390806001815401808255809150509060018203906000526020600020016000909192909190915090600019169055506060604051908101604052806000805490508152602001846000191681526020018381525060016000856000191660001916815260200190815260200160002060008201518160000155602082015181600101906000191690556040820151816002019080519060200190610967929190610f8a565b50905050600080549050905092915050565b600060016000846000191660001916815260200190815260200160002060000154111515610a0f576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252600e8152602001807f556e6b6e6f776e20706572736f6e00000000000000000000000000000000000081525060200191505060405180910390fd5b6020604051908101604052806000815250600160008460001916600019168152602001908152602001600020600301826040518082805190602001908083835b602083101515610a745780518252602082019150602081019050602083039250610a4f565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390206000019080519060200190610abd92919061100a565b506000600160008460001916600019168152602001908152602001600020600301826040518082805190602001908083835b602083101515610b145780518252602082019150602081019050602083039250610aef565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060010160006101000a81548160ff0219169083151502179055506020604051908101604052806000815250600160008460001916600019168152602001908152602001600020600301826040518082805190602001908083835b602083101515610bc65780518252602082019150602081019050602083039250610ba1565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390206002019080519060200190610c0f92919061100a565b505050565b60006060600080549050600080805480602002602001604051908101604052809291908181526020018280548015610c6f57602002820191906000526020600020905b81546000191681526020019060010190808311610c57575b50505050509050915091509091565b600080600090506000600160008660001916600019168152602001908152602001600020600001541115610d4757600160008560001916600019168152602001908152602001600020600301836040518082805190602001908083835b602083101515610d005780518252602082019150602081019050602083039250610cdb565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060010160009054906101000a900460ff1690505b8091505092915050565b6000600160008560001916600019168152602001908152602001600020600001541115610f595781600160008560001916600019168152602001908152602001600020600301836040518082805190602001908083835b602083101515610dcd5780518252602082019150602081019050602083039250610da8565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390206000019080519060200190610e1692919061100a565b5060018060008560001916600019168152602001908152602001600020600301836040518082805190602001908083835b602083101515610e6c5780518252602082019150602081019050602083039250610e47565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060010160006101000a81548160ff02191690831515021790555080600160008560001916600019168152602001908152602001600020600301836040518082805190602001908083835b602083101515610f0e5780518252602082019150602081019050602083039250610ee9565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390206002019080519060200190610f5792919061100a565b505b505050565b815481835581811115610f8557818360005260206000209182019101610f84919061108a565b5b505050565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10610fcb57805160ff1916838001178555610ff9565b82800160010185558215610ff9579182015b82811115610ff8578251825591602001919060010190610fdd565b5b50905061100691906110af565b5090565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061104b57805160ff1916838001178555611079565b82800160010185558215611079579182015b8281111561107857825182559160200191906001019061105d565b5b50905061108691906110af565b5090565b6110ac91905b808211156110a8576000816000905550600101611090565b5090565b90565b6110d191905b808211156110cd5760008160009055506001016110b5565b5090565b905600a165627a7a7230582081049195301d645185e115b61d64304dd54e09680435c074a2500df1fd0ff3540029"
						data: bytecode
					})
					.send({
						from: account,
						gas: 4700000
					})
					.then((newContractInstance) => {
						$("#confAddress").html(newContractInstance.options.address);
						myConferenceInstance = newContractInstance;
						//console.log(newContractInstance.options.address); // instance with the new contract address
					});
				} else {
					conferenceContract = new web3.eth.Contract(cabi, address);
					$("#confAddress").html(conferenceContract.options.address);
					myConferenceInstance = conferenceContract;
				}
			});
		}
	});
}

// Add Meeting
function addMeeting(room, note) {
	var room_= web3.utils.utf8ToHex(room); // convert string to hex (for bytes32)

	//unlock account for executing method of smart-contract
	web3.eth.personal.unlockAccount(account, accountpwd, 15000).then((response) => {
		myConferenceInstance.methods.AddMeeting(room_, note).send({from: account, gas: 2000000}).then((receipt) => {
			$("#MeetingResult").html(receipt.transactionHash)
		}).catch((error) => {
			$("#MeetingResult").html("error");
			console.log(error);
		});
	}).catch((error) => {
		console.log(error);
	});
}

function delMeeting(room) {
	var room_ = web3.utils.utf8ToHex(room);

	//unlock account for executing method of smart-contract
	web3.eth.personal.unlockAccount(account, accountpwd, 15000).then((response) => {
		//execute the method of smart-contract
		myConferenceInstance.methods.DeleteMeeting(room_).send({from: account, gas: 2000000}).then((receipt) => {
			$("#MeetingResult").html(receipt.transactionHash)
		}).catch((error) => {
			$("#MeetingResult").html("error");
			console.log(error);
		});
	}).catch((error) => {
		console.log(error);
	});
}

function checkPerson(room, pkey) {
	var res = "Person NOT found";
	var room_ = web3.utils.utf8ToHex(room);
	//var pkey_ = web3.utils.utf8ToHex(pkey);
	
	var pkey_ = CryptoJS.AES.encrypt(pkey, clientpwd).toString();

	//execute the method of smart-contract
	myConferenceInstance.methods.CheckPerson(room_, pkey_).call({from: account}, (error, result) => {
		if (result) {
			res = "Person found";
		}
		$("#checkPersonResult").html(res)
	});
}

function addPerson(room, pkey, pname) {
	var room_ = web3.utils.utf8ToHex(room);
	//var pkey_ = web3.utils.utf8ToHex(pkey);

	var pkey_ = CryptoJS.AES.encrypt(pkey, clientpwd).toString();

	//unlock account for executing method of smart-contract
	web3.eth.personal.unlockAccount(account, accountpwd, 15000).then((response) => {
		//execute the method of smart-contract
		myConferenceInstance.methods.AddPerson(room_, pkey_, pname).send({from: account, gas: 2000000}).then((receipt) => {
			$("#PersonResult").html(receipt.transactionHash)
		}).catch((error) => {
			$("#PersonResult").html("error");
			console.log(error);
		});
	}).catch((error) => {
		console.log(error);
	});
}

function delPerson(room, pkey) {
	var room_ = web3.utils.utf8ToHex(room);
	//var pkey_ = web3.utils.utf8ToHex(pkey);

	var pkey_ = CryptoJS.AES.encrypt(pkey, clientpwd).toString();

	//unlock account for executing method of smart-contract
	web3.eth.personal.unlockAccount(account, accountpwd, 15000).then((response) => {
		//execute the method of smart-contract
		myConferenceInstance.methods.DeletePerson(room_, pkey_).send({from: account, gas: 2000000}).then((receipt) => {
			$("#PersonResult").html(receipt.transactionHash)
		}).catch((error) => {
			$("#PersonResult").html("error");
			console.log(error);
		});
	}).catch((error) => {
		console.log(error);
	});
}

// --------------------------------------------------
window.onload = function() {

	// Initialize web3 and set the provider to the testRPC.
	if (typeof web3 !== 'undefined') {
		web3 = new Web3(web3.currentProvider);
	} else {
		var web3Provider;
		// set the provider you want from Web3.providers
		web3Provider = new Web3.providers.HttpProvider('http://127.0.0.1:7545');
		//web3Provider = new Web3.providers.HttpProvider('https://ropsten.infura.io/v3/954ef207d6fd42bb834d7b3f8c0f02df');
		web3 = new Web3(web3Provider);
	}

	//get list of blockchain accounts
	web3.eth.getAccounts(function(err, accs) {
		if (err != null) {
			alert("There was an error fetching your accounts.");
			return;
		}
		if (accs.length == 0) {
			alert("Couldn't get any accounts! Make sure your Ethereum client is configured correctly.");
			return;
		}
		accounts = accs;
		if(accounts.length > 2) account = accounts[3]; // store working account
		else account = accounts[0];
		
		initializeConference();
	});

	// Wire up the UI elements
	$("#addMeeting").click(function() {
		var room = $("#roomNumber").val();
		var note = $("#roomNote").val();
		addMeeting(room, note);
	});

	$("#delMeeting").click(function() {
		var room = $("#roomNumber").val();
		delMeeting(room);
	});

	$("#checkPerson").click(function() {
		var room = $("#roomNumber").val();
		var pkey = $("#personKey").val();
		checkPerson(room, pkey);
	});

	$("#addPerson").click(function() {
		var room = $("#roomNumber").val();
		var client = $("#personKey").val();
		var pname = $("#personName").val();
		addPerson(room, client, pname);
	});

	$("#delPerson").click(function() {
		var room = $("#roomNumber").val();
		var client = $("#personKey").val();
		delPerson(room, client);
	});
	
	$("#showSmartContract").click(function() {
		var visibleCode = $('#smartContractCode').is(":visible");
		$('#smartContractCode').toggle();
		$("#showSmartContract").text(visibleCode ? 'Hide' : 'Show');
	});	
	
	// Set value of wallet to accounts[1]
	//$("#ownerAddress").val(accounts[3]);
};
